var ue=Object.defineProperty;var de=(e,t,n)=>t in e?ue(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var A=(e,t,n)=>de(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const r of c.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();const fe="world1-001",pe="Intro 1",he=["########","#  .   #","#  $   #","#  @   #","#      #","########"],ye={id:fe,title:pe,map:he},xe="world1-002",me="Intro 2",we=["#########","#   .   #","#  $$   #","#   @   #","#       #","#########"],ge={id:xe,title:me,map:we},be="world1-003",ve="Corners matter",$e=["###########","#  . .    #","#  $ $    #","#   @     #","#         #","###########"],ke={id:be,title:ve,map:$e},Ee="world1-004",Se="Narrow Corridor",Me=["###########","#   .     #","# ### ### #","# $   $ @ #","# ### ### #","#     .   #","###########"],Ce={id:Ee,title:Se,map:Me},Ie="world1-005",Le="Order Matters",Pe=["###########","# .     . #","# ### ### #","#   $ $   #","# ### ### #","#     @   #","###########"],De={id:Ie,title:Le,map:Pe},Be="world1-006",Re="Trap Corners",Ae=["############","# .      . #","# ### ## ###","# $   ##   #","# ### ## ###","#   @      #","############"],Ue={id:Be,title:Re,map:Ae},Te="world1-007",Oe="Tunnel Logic",Ge=["#############","#   .   .   #","### ### ### #","#   $   $   #","# ### ### ###","#     @     #","#############"],Ne={id:Te,title:Oe,map:Ge},qe="world1-008",We="Split Paths",Ke=["#############","# .   #   . #","# ### # ### #","#   $   $   #","### ##### ###","#     @     #","#############"],je={id:qe,title:We,map:Ke},Fe="world1-009",Ye="Box Parking",He=["############","# .   .    #","# ### ###  #","#   $ $    #","# ### ###  #","#     @    #","############"],Xe={id:Fe,title:Ye,map:He},ze="world1-010",Je="Advanced Corridors",Ve=["#############","# .   ###   #","# ### # ### #","#   $   $   #","### ### # ###","#     @     #","#############"],_e={id:ze,title:Je,map:Ve},H=[ye,ge,ke,Ce,De,Ue,Ne,je,Xe,_e];function Qe(e){const t=e.map.length,n=Math.max(...e.map.map(i=>i.length)),s=new Uint8Array(n*t),o=new Uint8Array(n*t),c=new Uint8Array(n*t);let r=-1;for(let i=0;i<t;i++){const u=e.map[i].padEnd(n," ");for(let a=0;a<n;a++){const l=u[a],f=i*n+a;l==="#"&&(s[f]=1),(l==="."||l==="*"||l==="+")&&(o[f]=1),(l==="$"||l==="*")&&(c[f]=1),(l==="@"||l==="+")&&(r=f)}}if(r<0)throw new Error(`Level '${e.id}' has no player '@'`);return{w:n,h:t,walls:s,goals:o,boxes:c,player:r}}function T(e){return{w:e.w,h:e.h,walls:e.walls.slice(),goals:e.goals.slice(),boxes:e.boxes.slice(),player:e.player}}function U(e,t,n){return t*n+e}function v(e,t){return{x:e%t,y:Math.floor(e/t)}}const I={U:{dx:0,dy:-1},D:{dx:0,dy:1},L:{dx:-1,dy:0},R:{dx:1,dy:0}};function Q(e,t,n){const{x:s,y:o}=v(e,n),c=I[t];return(o+c.dy)*n+(s+c.dx)}class Ze{constructor(t){A(this,"ctx");A(this,"canvas");const n=t.getContext("2d");if(!n)throw new Error("Canvas 2D context not available");this.ctx=n,this.canvas=t}draw(t){const{w:n,h:s}=t,o=this.ctx,c=10,r=Math.floor(Math.min((this.canvas.width-c*2)/n,(this.canvas.height-c*2)/s)),i=Math.floor((this.canvas.width-r*n)/2),u=Math.floor((this.canvas.height-r*s)/2);o.clearRect(0,0,this.canvas.width,this.canvas.height);for(let a=0;a<n*s;a++){const{x:l,y:f}=v(a,n),d=i+l*r,p=u+f*r;if(o.fillStyle="rgba(127,127,127,0.10)",o.fillRect(d,p,r,r),t.walls[a]){o.fillStyle="rgba(127,127,127,0.55)",o.fillRect(d,p,r,r);continue}if(t.goals[a]&&(o.strokeStyle="rgba(127,127,127,0.90)",o.lineWidth=Math.max(2,Math.floor(r/12)),o.beginPath(),o.arc(d+r/2,p+r/2,r*.18,0,Math.PI*2),o.stroke()),t.boxes[a]){o.fillStyle=t.goals[a]?"rgba(80,180,120,0.65)":"rgba(220,170,80,0.65)";const h=Math.floor(r*.12);o.fillRect(d+h,p+h,r-2*h,r-2*h)}t.player===a&&(o.fillStyle="rgba(90,150,230,0.80)",o.beginPath(),o.arc(d+r/2,p+r/2,r*.22,0,Math.PI*2),o.fill())}o.strokeStyle="rgba(127,127,127,0.12)",o.lineWidth=1;for(let a=0;a<=n;a++)o.beginPath(),o.moveTo(i+a*r,u),o.lineTo(i+a*r,u+s*r),o.stroke();for(let a=0;a<=s;a++)o.beginPath(),o.moveTo(i,u+a*r),o.lineTo(i+n*r,u+a*r),o.stroke()}}function ne(e,t){const n=e.w,s=e.h,o=Q(e.player,t,n),{x:c,y:r}=v(e.player,n),i=I[t],u=c+i.dx,a=r+i.dy;if(u<0||u>=n||a<0||a>=s)return{changed:!1,pushed:!1};if(e.walls[o])return{changed:!1,pushed:!1};if(e.boxes[o]){const l=Q(o,t,n),f=u+i.dx,d=a+i.dy;return f<0||f>=n||d<0||d>=s?{changed:!1,pushed:!1}:e.walls[l]?{changed:!1,pushed:!1}:e.boxes[l]?{changed:!1,pushed:!1}:(e.boxes[o]=0,e.boxes[l]=1,e.player=o,{changed:!0,pushed:!0})}return e.player=o,{changed:!0,pushed:!1}}function P(e){for(let t=0;t<e.boxes.length;t++)if(e.boxes[t]&&!e.goals[t])return!1;return!0}class oe{constructor(){A(this,"past",[]);A(this,"future",[])}push(t){this.past.push({player:t.player,boxes:t.boxes.slice()}),this.future.length=0}undo(t){if(this.past.length<=1)return!1;const n=this.past.pop();this.future.push(n);const s=this.past[this.past.length-1];return t.player=s.player,t.boxes=s.boxes.slice(),!0}redo(t){const n=this.future.pop();return n?(this.past.push({player:n.player,boxes:n.boxes.slice()}),t.player=n.player,t.boxes=n.boxes.slice(),!0):!1}reset(t){if(this.past.length===0)return;const n=this.past[0];this.past=[n],this.future=[],t.player=n.player,t.boxes=n.boxes.slice()}init(t){this.past=[{player:t.player,boxes:t.boxes.slice()}],this.future=[]}stats(){return{undo:this.past.length-1,redo:this.future.length}}}function et(e){const t=n=>{const o={U:"u",D:"d",L:"l",R:"r"}[n.dir];return n.pushed?o.toUpperCase():o};return e.map(t).join("")}function Z(e){const{w:t,h:n}=e,s=o=>o<0||o>=t*n?!0:e.walls[o]===1;for(let o=0;o<t*n;o++){if(!e.boxes[o]||e.goals[o])continue;const{x:c,y:r}=v(o,t),i=r===0?-1:U(c,r-1,t),u=r===n-1?-1:U(c,r+1,t),a=c===0?-1:U(c-1,r,t),l=c===t-1?-1:U(c+1,r,t),f=s(i),d=s(u),p=s(a),h=s(l);if(f&&p||f&&h||d&&p||d&&h)return!0}return!1}function se(e){const{w:t,h:n}=e,s=new Uint8Array(t*n),o=new Int32Array(t*n);let c=0,r=0;for(s[e.player]=1,o[r++]=e.player;c<r;){const i=o[c++],{x:u,y:a}=v(i,t);for(const l of Object.values(I)){const f=u+l.dx,d=a+l.dy;if(f<0||f>=t||d<0||d>=n)continue;const p=U(f,d,t);s[p]||e.walls[p]||e.boxes[p]||(s[p]=1,o[r++]=p)}}return s}function tt(e,t,n){if(t===n)return"";const{w:s,h:o}=e,c=new Int32Array(s*o);c.fill(-1);const r=new Int8Array(s*o),i=new Int32Array(s*o);let u=0,a=0;i[a++]=t,c[t]=t;const l=[{dx:0,dy:-1,ch:"u"},{dx:0,dy:1,ch:"d"},{dx:-1,dy:0,ch:"l"},{dx:1,dy:0,ch:"r"}];for(;u<a;){const f=i[u++],{x:d,y:p}=v(f,s);for(let h=0;h<l.length;h++){const w=l[h],x=d+w.dx,L=p+w.dy;if(x<0||x>=s||L<0||L>=o)continue;const g=L*s+x;if(c[g]===-1&&!e.walls[g]&&!e.boxes[g]){if(c[g]=f,r[g]=h,g===n){let D="",$=g;for(;$!==t;){const B=r[$];D=l[B].ch+D,$=c[$]}return D}i[a++]=g}}}return null}async function re(e,t=2e5){const n=performance.now();if(Z(e))return{ok:!1,reason:"Immediate deadlock detected (corner).",timeMs:performance.now()-n};if(P(e))return{ok:!0,minPushes:0,steps:[],expanded:0,timeMs:performance.now()-n};const s=e.w,o=e.h,c=s*o,r=(p,h)=>{let w=p.toString(36)+"|";for(let x=0;x<c;x++)h[x]&&(w+=x.toString(36)+",");return w},i=[];let u=0;const a=r(e.player,e.boxes),l=new Map,f={player:e.player,boxes:e.boxes.slice(),parentKey:null,walk:"",pushDir:null};l.set(a,f),i.push(f);let d=0;for(;u<i.length;){const p=i[u++];if(d++,d>t)return{ok:!1,reason:`Search limit exceeded (expanded>${t}).`,expanded:d,timeMs:performance.now()-n};const h=T(e);h.player=p.player,h.boxes=p.boxes;const w=se(h);for(let x=0;x<c;x++){if(!p.boxes[x])continue;const{x:L,y:g}=v(x,s);for(const[D,$]of Object.entries(I)){const B=L-$.dx,q=g-$.dy,W=L+$.dx,K=g+$.dy;if(B<0||B>=s||q<0||q>=o||W<0||W>=s||K<0||K>=o)continue;const z=q*s+B,j=K*s+W;if(!w[z]||e.walls[j]||p.boxes[j])continue;const J=tt(h,p.player,z);if(J==null)continue;const R=p.boxes.slice();R[x]=0,R[j]=1;const F=x,O=T(e);if(O.player=F,O.boxes=R,Z(O))continue;const Y=r(F,R);if(l.has(Y))continue;const V={player:F,boxes:R,parentKey:r(p.player,p.boxes),walk:J,pushDir:D};if(l.set(Y,V),P(O)){const _=ot(l,Y,e);return{ok:!0,minPushes:nt(_),steps:_,expanded:d,timeMs:performance.now()-n}}i.push(V)}}}return{ok:!1,reason:"No solution found.",expanded:d,timeMs:performance.now()-n}}function nt(e){return e.reduce((t,n)=>t+(n.pushed?1:0),0)}function ot(e,t,n){const s=[];let o=t;for(;o;){const i=e.get(o);s.push(i),o=i.parentKey}s.reverse();const c=[],r=T(n);for(let i=1;i<s.length;i++){const u=s[i];for(const a of u.walk){const l=st(a);c.push({dir:l,pushed:!1}),rt(r,l)}u.pushDir&&(c.push({dir:u.pushDir,pushed:!0}),ct(r,u.pushDir))}return c}function st(e){switch(e){case"u":return"U";case"d":return"D";case"l":return"L";case"r":return"R";default:throw new Error(`Invalid walk dir: ${e}`)}}function rt(e,t){const n=e.w,{x:s,y:o}=v(e.player,n),c=I[t],r=s+c.dx,u=(o+c.dy)*n+r;e.player=u}function ct(e,t){const n=e.w,{x:s,y:o}=v(e.player,n),c=I[t],r=(o+c.dy)*n+(s+c.dx),i=(o+2*c.dy)*n+(s+2*c.dx);e.boxes[r]=0,e.boxes[i]=1,e.player=r}const lt={map:["###############","#      .      #","#   #####     #","#   #   #  .  #","#   #   #     #","#   #####     #","#      .      #","#             #","###############"]};async function it(e,t,n,s=[8,30]){let c=at(e,t);for(let l=0;l<n;l++){const f=ft(c);f&&(c=f)}if(pt(c))return null;const r=await re(c,12e4);if(!r.ok||!r.steps)return null;const i=r.minPushes??0;if(i<s[0]||i>s[1])return null;const u=ht(c,`gen-${Date.now()}`,`Generated (${i} pushes)`),a=r.steps.map(l=>l.pushed?ee(l.dir).toUpperCase():ee(l.dir)).join("");return{level:u,solution:a,pushes:i}}function ee(e){return{U:"u",D:"d",L:"l",R:"r"}[e]}function at(e,t){const n=e.map.length,s=Math.max(...e.map.map(l=>l.length)),o=new Uint8Array(s*n),c=[],r=new Uint8Array(s*n);for(let l=0;l<n;l++){const f=e.map[l].padEnd(s," ");for(let d=0;d<s;d++){const p=f[d],h=l*s+d;p==="#"&&(o[h]=1),p==="."&&c.push(h)}}if(c.length<t)throw new Error("Arena has fewer goals than requested boxCount.");ce(c);for(let l=0;l<t;l++)r[c[l]]=1;let i=dt(o,r);const u={w:s,h:n,walls:o,goals:ut(c,s*n),boxes:r,player:i},a=se(u);for(let l=0;l<a.length;l++)if(a[l]&&!(o[l]||r[l])){i=l;break}return u.player=i,u}function ut(e,t){const n=new Uint8Array(t);for(const s of e)n[s]=1;return n}function dt(e,t){for(let n=0;n<e.length;n++)if(!e[n]&&!t[n])return n;throw new Error("No floor cell found.")}function ce(e){for(let t=e.length-1;t>0;t--){const n=Math.random()*(t+1)|0;[e[t],e[n]]=[e[n],e[t]]}}function ft(e){const t=["U","D","L","R"];ce(t);const{w:n,h:s}=e,o=e.player,{x:c,y:r}=v(o,n);for(const i of t){const u=I[i],a=c+u.dx,l=r+u.dy,f=c-u.dx,d=r-u.dy;if(a<0||a>=n||l<0||l>=s||f<0||f>=n||d<0||d>=s)continue;const p=l*n+a,h=d*n+f;if(!e.boxes[p]||e.walls[h]||e.boxes[h])continue;const w=T(e);return w.boxes[p]=0,w.boxes[o]=1,w.player=h,w}return null}function pt(e){for(let t=0;t<e.boxes.length;t++)if(e.boxes[t]&&!e.goals[t])return!1;return!0}function ht(e,t,n){const s=[];for(let o=0;o<e.h;o++){let c="";for(let r=0;r<e.w;r++){const i=o*e.w+r,u=e.walls[i]===1,a=e.goals[i]===1,l=e.boxes[i]===1,f=e.player===i;let d=" ";u?d="#":a&&(d="."),l&&a?d="*":l&&(d="$"),f&&a?d="+":f&&(d="@"),c+=d}s.push(c.replace(/\s+$/g,""))}return{id:t,title:n,map:s}}const yt=document.getElementById("game"),xt=new Ze(yt),G=document.getElementById("levelSelect"),mt=document.getElementById("btnReset"),wt=document.getElementById("btnUndo"),gt=document.getElementById("btnRedo"),bt=document.getElementById("btnSolve"),vt=document.getElementById("btnPlay"),$t=document.getElementById("btnGenerate"),kt=document.getElementById("genBoxes"),Et=document.getElementById("genSteps"),St=document.getElementById("stats"),b=document.getElementById("solution"),Mt=document.getElementById("statusBadge");let C=null,y=null,E=new oe,S=null,k=!1;function m(e){Mt.textContent=e}function X(e){C=e,y=Qe(e),E=new oe,E.init(y),S=null,b.textContent="",m("Ready"),M()}function M(){if(!y)return;xt.draw(y);const{undo:e,redo:t}=E.stats(),n=P(y),s=Ct(y);St.textContent=`Level: ${(C==null?void 0:C.id)??"-"}
Title: ${(C==null?void 0:C.title)??"-"}
Undo: ${e}  Redo: ${t}
Boxes on goals: ${s.onGoals}/${s.total}
Win: ${n?"YES":"NO"}
`,n&&m("✅ Solved!")}function Ct(e){let t=0,n=0;for(let s=0;s<e.boxes.length;s++)e.boxes[s]&&(n++,e.goals[s]&&t++);return{onGoals:t,total:n}}function N(e){if(!y||k)return;const t=P(y);ne(y,e).changed&&(E.push(y),S=null,b.textContent="",M()),!t&&P(y)&&m("✅ Solved!")}function le(){!y||k||(E.reset(y),S=null,b.textContent="",m("Ready"),M())}function ie(){!y||k||E.undo(y)&&(S=null,b.textContent="",m("Ready"),M())}function ae(){!y||k||E.redo(y)&&(m("Ready"),M())}async function It(){var n;if(!y||k)return;m("Solving..."),b.textContent="Solving, please wait...";const e=T(y),t=await re(e,2e5);if(!t.ok||!t.steps){m("No solution"),b.textContent=`No solution found.
Reason: ${t.reason??"unknown"}
Expanded: ${t.expanded??0}
Time: ${(t.timeMs??0).toFixed(1)} ms`;return}S=t.steps,m(`Solved (min pushes = ${t.minPushes})`),b.textContent=`Min pushes: ${t.minPushes}
Expanded: ${t.expanded}
Time: ${(n=t.timeMs)==null?void 0:n.toFixed(1)} ms

Moves (uppercase=push, lowercase=walk):
${et(S)}
`}async function Lt(){if(!(!y||!S||k)){k=!0,m("Playing..."),E.reset(y),M();for(const e of S)await Pt(35),ne(y,e.dir),E.push(y),M();k=!1,m(P(y)?"✅ Solved!":"Done")}}function Pt(e){return new Promise(t=>setTimeout(t,e))}function Dt(){G.innerHTML="";for(const e of H){const t=document.createElement("option");t.value=e.id,t.textContent=`${e.id} — ${e.title}`,G.appendChild(t)}G.addEventListener("change",()=>{const e=G.value,t=H.find(n=>n.id===e);t&&X(t)}),X(H[0])}function Bt(){mt.addEventListener("click",le),wt.addEventListener("click",ie),gt.addEventListener("click",ae),bt.addEventListener("click",It),vt.addEventListener("click",Lt),$t.addEventListener("click",async()=>{if(k)return;const e=te(parseInt(kt.value,10)||3,1,6),t=te(parseInt(Et.value,10)||60,10,250);m("Generating..."),b.textContent="Generating solvable level (reverse pull) ...";for(let n=0;n<20;n++){const s=await it(lt,e,t,[8,35]);if(s){X(s.level),b.textContent=`Generated level with min pushes: ${s.pushes}
Solution: ${s.solution}
Tip: Click "Play solution" after running Solve.
`,m("Generated ✅");return}}m("Generate failed"),b.textContent="Could not generate a level matching the difficulty range. Try increasing steps or changing box count."})}function te(e,t,n){return Math.max(t,Math.min(n,e))}function Rt(){window.addEventListener("keydown",e=>{const t=e.key.toLowerCase();if(t==="arrowup"||t==="w")return e.preventDefault(),N("U");if(t==="arrowdown"||t==="s")return e.preventDefault(),N("D");if(t==="arrowleft"||t==="a")return e.preventDefault(),N("L");if(t==="arrowright"||t==="d")return e.preventDefault(),N("R");if(t==="z")return e.preventDefault(),ie();if(t==="y")return e.preventDefault(),ae();if(t==="r")return e.preventDefault(),le()})}Dt();Bt();Rt();M();
